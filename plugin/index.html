<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <script src="./main.js"></script>
    <style>
      div {
        margin: auto;
      }
      
      /* 图片查看对话框样式 */
      #imgDialog {
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        padding: 10px;
        background: white;
        min-width: 400px;
        min-height: 300px;
        max-width: 90vw;
        max-height: 90vh;
        width: 600px;
        height: 500px;
        overflow: auto;
        position: relative;
      }
      
      #imgDialog::backdrop {
        background-color: rgba(0,0,0,0.5);
      }
      
      /* 自定义拖拽手柄 */
      #resizeHandle {
        position: absolute;
        width: 16px;
        height: 16px;
        right: 4px;
        bottom: 4px;
        cursor: se-resize;
        background: linear-gradient(45deg, transparent 30%, #ccc 30%, #ccc 50%, transparent 50%);
        border-radius: 2px;
        z-index: 1000;
      }
      
      #resizeHandle:hover {
        background: linear-gradient(45deg, transparent 30%, #999 30%, #999 50%, transparent 50%);
      }
      
      .close-button {
        padding: 8px 16px;
        background-color: #1976d2;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-family: inherit;
      }
      
      .close-button:hover {
        background-color: #1565c0;
      }
      
      .loading-text {
        color: #666;
        font-size: 14px;
        text-align: center;
        padding: 20px;
      }
      
      .error-text {
        color: #c62828;
        font-size: 14px;
        padding: 20px;
        background-color: #ffebee;
        border-radius: 4px;
        text-align: center;
      }
      
      #photo {
        max-width: 100%;
        height: auto;
        display: block;
        margin-bottom: 10px;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.1s ease;
        cursor: zoom-in;
      }
      
      /* 缩放控制样式 */
      .zoom-controls {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(0,0,0,0.8);
        border-radius: 4px;
        padding: 8px;
        display: flex;
        gap: 8px;
        z-index: 10001;
      }
      
      .zoom-btn {
        background: rgba(255,255,255,0.2);
        color: white;
        border: none;
        border-radius: 3px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.2s;
      }
      
      .zoom-btn:hover {
        background: rgba(255,255,255,0.3);
      }
      
      .zoom-info {
        color: white;
        font-size: 12px;
        padding: 4px 8px;
        background: rgba(0,0,0,0.5);
        border-radius: 3px;
      }
      
      /* 确保图片查看面板不会产生滚动条 */
      #imageViewerPanel {
        overflow: hidden !important;
      }
      
      /* 阻断滚动冒泡到外部 */
      #imageViewerPanel, #imageContainer {
        overscroll-behavior: contain;
        overscroll-behavior-y: contain;
      }
      
      /* 禁用图片拖拽 */
      #panelPhoto {
        pointer-events: auto;
        -webkit-user-drag: none;
        -khtml-user-drag: none;
        -moz-user-drag: none;
        -o-user-drag: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
    </style>
  </head>

  <body>
    <div>
      <div id="container"></div>
    </div>
    
    <!-- 图片查看对话框 -->
    <dialog id="imgDialog">
      <img id="photo" alt="加载中…" />
      <div id="resizeHandle"></div>
      <footer style="text-align: right; margin-top: 10px;">
        <button class="close-button" id="closeDialogBtn">关闭</button>
      </footer>
    </dialog>
    
    <!-- 图片查看面板容器 -->
    <div id="imageViewerPanel" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); overflow: hidden; z-index: 999999;">
      <div id="imageContainer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; touch-action: none; overscroll-behavior: contain;" tabindex="0">
        <img id="panelPhoto" src="" alt="加载中…" style="transform-origin: center center; transition: transform 0.1s; max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 4px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); user-select: none;" />
      </div>
      <div id="zoomInfo" style="position: absolute; top: 8px; right: 8px; color: #fff; background: rgba(0,0,0,0.5); padding: 2px 6px; border-radius: 4px; font-size: 12px;">100%</div>
      <button id="closePanelBtn" class="close-button" style="position: absolute; top: 8px; left: 8px;">× 关闭</button>
    </div>

    <script>
      // 图片查看对话框功能
      const imgDialog = document.getElementById('imgDialog');
      const photo = document.getElementById('photo');
      const closeDialogBtn = document.getElementById('closeDialogBtn');
      const resizeHandle = document.getElementById('resizeHandle');
      
      // 图片查看面板功能
      const imageViewerPanel = document.getElementById('imageViewerPanel');
      const imageContainer = document.getElementById('imageContainer');
      const panelPhoto = document.getElementById('panelPhoto');
      const zoomInfo = document.getElementById('zoomInfo');
      const closePanelBtn = document.getElementById('closePanelBtn');
      
      // 缩放状态
      let currentZoom = 1;
      let minZoom = 0.1;
      let maxZoom = 5.0;
      let zoomStep = 0.1;
      
      // 关闭对话框
      closeDialogBtn.addEventListener('click', () => {
        imgDialog.close();
      });
      
      // 点击对话框外部关闭
      imgDialog.addEventListener('click', (event) => {
        if (event.target === imgDialog) {
          imgDialog.close();
        }
      });
      
      // 自定义拖拽缩放
      let resizing = false;
      let startX, startY, startW, startH;
      
      resizeHandle.addEventListener('pointerdown', (e) => {
        resizing = true;
        startX = e.clientX;
        startY = e.clientY;
        startW = imgDialog.offsetWidth;
        startH = imgDialog.offsetHeight;
        e.preventDefault();
      });
      
      window.addEventListener('pointermove', (e) => {
        if (!resizing) return;
        
        const newWidth = Math.max(400, Math.min(90 * window.innerWidth / 100, startW + e.clientX - startX));
        const newHeight = Math.max(300, Math.min(90 * window.innerHeight / 100, startH + e.clientY - startY));
        
        imgDialog.style.width = newWidth + 'px';
        imgDialog.style.height = newHeight + 'px';
      });
      
      window.addEventListener('pointerup', () => {
        resizing = false;
      });
      
      // 关闭图片查看面板
      closePanelBtn.addEventListener('click', () => {
        imageViewerPanel.style.display = 'none';
        isImagePanelOpen = false;
        // 恢复背景页面滚动
        document.body.style.overflow = '';
        document.documentElement.style.overflow = '';
        document.body.style.position = '';
        document.body.style.width = '';
        document.body.style.top = '';
      });
      
      // 点击面板背景关闭
      imageViewerPanel.addEventListener('click', (event) => {
        if (event.target === imageViewerPanel) {
          imageViewerPanel.style.display = 'none';
          isImagePanelOpen = false;
          currentZoom = 1;
          updateZoom();
          // 恢复背景页面滚动
          document.body.style.overflow = '';
          document.documentElement.style.overflow = '';
          document.body.style.position = '';
          document.body.style.width = '';
          document.body.style.top = '';
        }
      });
      

      
      // 缩放功能实现
      function updateZoom() {
        panelPhoto.style.transform = `scale(${currentZoom})`;
        zoomInfo.textContent = `${Math.round(currentZoom * 100)}%`;
      }
      

      
      // 完全拦截滚轮事件
      function onWheel(e) {
        if (isImagePanelOpen) {
          e.preventDefault();
          e.stopImmediatePropagation();
          const dir = e.deltaY < 0 ? 1 : -1;
          currentZoom = Math.min(maxZoom, Math.max(minZoom, currentZoom + dir * zoomStep));
          updateZoom();
          console.log('滚轮缩放:', currentZoom);
          return false;
        }
      }
      
      // 在 document 和 window 两个层级都拦截 wheel
      document.addEventListener('wheel', onWheel, { passive: false, capture: true });
      window.addEventListener('wheel', onWheel, { passive: false, capture: true });
      

      
      // 全局滚轮事件阻止 - 当图片面板打开时阻止所有背景滚动
      let isImagePanelOpen = false;
      
      // 阻止其他滚动事件 - 只在面板打开时生效
      function preventOtherScroll(event) {
        if (isImagePanelOpen) {
          // 检查事件是否来自图片面板
          const target = event.target;
          if (target && (target.closest('#imageViewerPanel') || target === imageViewerPanel)) {
            // 事件来自图片面板，不阻止
            return;
          }
          // 阻止其他区域的滚动
          event.preventDefault();
          event.stopPropagation();
          event.stopImmediatePropagation();
          return false;
        }
      }
      
      // 添加其他事件监听器
      document.addEventListener('touchmove', preventOtherScroll, { capture: true, passive: false });
      document.addEventListener('scroll', preventOtherScroll, { capture: true, passive: false });
      document.addEventListener('keydown', (event) => {
        if (isImagePanelOpen && (event.key === 'ArrowUp' || event.key === 'ArrowDown' || event.key === 'PageUp' || event.key === 'PageDown' || event.key === ' ' || event.key === 'Home' || event.key === 'End')) {
          // 检查事件是否来自图片面板
          const target = event.target;
          if (target && (target.closest('#imageViewerPanel') || target === imageViewerPanel)) {
            // 事件来自图片面板，允许处理
            return;
          }
          event.preventDefault();
          event.stopPropagation();
          return false;
        }
      }, { capture: true });
      
            // 全局函数：显示图片面板
      window.showImagePanel = async function(imageUrl) {
        console.log('=== 图片面板调试信息 ===');
        console.log('showImagePanel 函数被调用');
        console.log('图片URL:', imageUrl);
        console.log('网络状态:', navigator.onLine ? '在线' : '离线');
        console.log('imageViewerPanel 元素:', imageViewerPanel);
        console.log('panelPhoto 元素:', panelPhoto);
          
          if (!imageUrl) {
            console.error('错误：未提供图片URL');
            imageViewerPanel.style.display = 'flex';
            return;
          }
          
          // 重置缩放状态
          currentZoom = 1;
          updateZoom();
          
          // 显示面板
          imageViewerPanel.style.display = 'flex';
          isImagePanelOpen = true;
          
          // 让容器获得焦点，确保滚轮事件被捕获
          imageContainer.focus();
          
          console.log('面板显示状态:', imageViewerPanel.style.display);
          console.log('面板可见性:', imageViewerPanel.offsetWidth, 'x', imageViewerPanel.offsetHeight);
          console.log('面板位置:', imageViewerPanel.offsetTop, imageViewerPanel.offsetLeft);
          console.log('面板z-index:', imageViewerPanel.style.zIndex);
          console.log('面板背景色:', imageViewerPanel.style.backgroundColor);
          
          // 阻止背景页面滚动
          document.body.style.overflow = 'hidden';
          document.documentElement.style.overflow = 'hidden';
          document.body.style.position = 'fixed';
          document.body.style.width = '100%';
          document.body.style.top = '0';
          
          zoomInfo.textContent = '100%';
          
          try {
            console.log('开始加载图片:', imageUrl);
            
            // 先测试一个简单的图片，看看面板是否工作
            console.log('测试面板功能...');
            panelPhoto.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZmYwMDAwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyMCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPlRlc3QgSW1hZ2U8L3RleHQ+PC9zdmc+';
            
            // 延迟加载实际图片
            setTimeout(() => {
              console.log('加载实际图片:', imageUrl);
              panelPhoto.src = imageUrl;
              
              // 添加加载事件监听
              panelPhoto.onload = function() {
                console.log('✅ 面板图片加载成功:', imageUrl);
                console.log('图片尺寸:', panelPhoto.naturalWidth, 'x', panelPhoto.naturalHeight);
                
                // 确保图片加载完成后也绑定滚轮事件
                panelPhoto.addEventListener('wheel', onWheel, { passive: false, capture: true });
                
                // 图片加载完成后再次让容器获得焦点
                imageContainer.focus();
              };
              
              panelPhoto.onerror = function() {
                console.error('❌ 面板图片加载失败:', imageUrl);
                
                // 尝试方法2：使用Image对象
                console.log('方法2：使用Image对象');
                const testImg = new Image();
                testImg.onload = function() {
                  console.log('✅ Image对象加载成功:', imageUrl);
                  panelPhoto.src = imageUrl;
                };
                
                testImg.onerror = function() {
                  console.error('❌ Image对象也加载失败:', imageUrl);
                  
                  // 显示错误信息
                  const errorDiv = document.createElement('div');
                  errorDiv.style.cssText = 'color: #ff6b6b; font-size: 14px; text-align: center; padding: 20px; background: rgba(255, 107, 107, 0.1); border-radius: 4px; margin: 20px;';
                  errorDiv.innerHTML = '图片加载失败<br><br>URL: ' + imageUrl + '<br><br>可能的原因：<br>1. 网络连接问题<br>2. 图片URL无效<br>3. 跨域访问限制';
                  
                  // 清空面板内容并添加错误信息
                  const panelContent = imageViewerPanel.querySelector('div:nth-child(2)');
                  panelContent.innerHTML = '';
                  panelContent.appendChild(errorDiv);
                };
                
                testImg.src = imageUrl;
              };
            }, 1000);
            
          } catch (error) {
            console.error('图片加载错误:', error);
          }
        };
        
        // 测试函数是否可用
        console.log('showImagePanel 函数已定义:', typeof window.showImagePanel);
        
        // 确保函数在全局可用
        if (typeof window.showImagePanel === 'function') {
          console.log('✅ showImagePanel 函数已成功定义并可用');
        } else {
          console.error('❌ showImagePanel 函数定义失败');
        }
        
        // 全局函数：显示图片对话框
        window.showImageDialog = async function(imageUrl) {
        console.log('=== 图片对话框调试信息 ===');
        console.log('图片URL:', imageUrl);
        console.log('网络状态:', navigator.onLine ? '在线' : '离线');
        
        if (!imageUrl) {
          console.error('错误：未提供图片URL');
          photo.alt = '未提供图片URL';
          imgDialog.showModal();
          return;
        }
        
        // 显示加载状态
        photo.alt = '加载中…';
        imgDialog.showModal();
        
        try {
          // 直接设置图片src，就像参考附件那样
          console.log('开始加载图片:', imageUrl);
          
          // 创建测试图片来获取尺寸信息
          const testImg = new Image();
          testImg.onload = function() {
            console.log('✅ 图片加载成功:', imageUrl);
            console.log('图片尺寸:', testImg.naturalWidth, 'x', testImg.naturalHeight);
            
            // 直接设置对话框图片的src
            photo.src = imageUrl;
            photo.alt = '参考附件';
          };
          
          testImg.onerror = function() {
            console.error('❌ 图片加载失败:', imageUrl);
            photo.alt = '图片加载失败';
            showError(imageUrl);
          };
          
          // 开始加载测试图片
          testImg.src = imageUrl;
          
        } catch (error) {
          console.error('图片加载错误:', error);
          photo.alt = '图片加载失败';
          showError(imageUrl);
        }
      };
      
      // 显示错误信息
      function showError(imageUrl) {
        const errorContainer = document.createElement('div');
        errorContainer.className = 'error-text';
        errorContainer.innerHTML = '图片加载失败<br><br>图片URL: ' + imageUrl + '<br><br>可能的原因：<br>1. 网络连接问题<br>2. 图片URL无效<br>3. 跨域访问限制';
        
        const testButton = document.createElement('button');
        testButton.textContent = '测试网络连接';
        testButton.style.cssText = 'padding: 5px 10px; background: #1976d2; color: white; border: none; border-radius: 3px; cursor: pointer; margin-top: 10px;';
        testButton.addEventListener('click', () => {
          window.testNetworkConnection();
        });
        
        // 清空对话框内容并添加错误信息
        imgDialog.innerHTML = '';
        imgDialog.appendChild(errorContainer);
        imgDialog.appendChild(testButton);
        imgDialog.appendChild(resizeHandle);
        imgDialog.appendChild(closeDialogBtn.parentElement);
      }
      
      // 网络连接测试
      window.testNetworkConnection = function() {
        console.log('=== 网络连接测试 ===');
        
        // 测试基本网络连接
        fetch('https://httpbin.org/get', { method: 'GET' })
          .then(response => {
            console.log('✅ 基本网络连接正常:', response.status);
          })
          .catch(error => {
            console.error('❌ 基本网络连接失败:', error);
          });
        
        // 测试目标域名连接
        fetch('https://img.365d4u.com', { method: 'HEAD' })
          .then(response => {
            console.log('✅ 目标域名连接正常:', response.status);
          })
          .catch(error => {
            console.error('❌ 目标域名连接失败:', error);
          });
      };
    </script>
  </body>
</html>
